naxsi dynamic configuration (aka nginx vars)

Since 0.49, naxsi supports a limited set of variables that can override or modify its behavior.

 * naxsi_flag_learning : If present, this variable will override naxsi learning flag ("0" to disable learning, "1" to enable it).
 * naxsi_flag_post_action : If present and set to "0" this variable may be used to disable post_action in learning mode. 
 * naxsi_flag_enable : if present, this variable will override naxsi "SecRulesEnabled" ("0" to disable naxsi, "1" to enable).
 * naxsi_extensive_log : If present (and set to "1"), this variable will force naxsi to log the CONTENT of variable matching rules (see notes at bottom).

== Gentle reminder ==

It is important to know that naxsi operates at the REWRITE phase of nginx. Thus, setting those variables directly in the location where naxsi is present is ineffective (as naxsi will be called before variable set is effective). 

This is correct:

{{{
set $naxsi_flag_enable 0;
location / {
...
}
}}}

But this is wrong:
{{{
location / {
         set $naxsi_flag_learning 1;
 ...
}
}}}

With that said, you can use the power of nginx, lua, * to change naxsi's behavior. The presence of these variables will enable/disable learning mode, naxsi itself or force extensive logging. 

You can thus do things naxsi is usually not able to, like modifying its behavior according to (nginx) variables set at run-time :

{{{
# Disable naxsi if client ip is 127.0.0.1
if ($remote_addr = "127.0.0.1") {
 set $naxsi_flag_disable 1;
}
}}}

Those variables can as well be set from lua scripts (see nginx's mod_lua).


== naxsi_flag_post_action ==

This option may be used if you don't intend to use live learning at all and only perform logs learning. Or, if you intend to run a learning daemon for live learning on a public site (oh my) and you want to pre filter your learning sources.

You can then disable the post_action that naxsi usually does while in learning mode. Trying to set it to "1" is useless and/or dangerous in all situations.

== naxsi_flag_disable ==

If naxsi_flag_disable variable is present and set to 0, naxsi will be disabled in this request. This allows you to partially disable naxsi in specific conditions.

To completely disable naxsi for "trusted" users :

{{{
set $naxsi_flag_enable 0;

location / {
...
}
}}}

== naxsi_flag_learning ==

If naxsi_flag_learning variable is present, this value will override naxsi's current static configuration regarding learning mode.

{{{
if ($remote_addr = "1.2.3.4") {
set $naxsi_flag_learning 1;
}

location / {
...
}
}}}

== naxsi_flag_enable ==
Naxsi flag_enable is to be used in very specific cases.
If you have a configuration where you explicitly disabled naxsi :

{{{
location / {
SecRulesEnabled;
SecRulesDisabled;
}
}}}

Then you can enable it upon specific conditions :

{{{
if ($uri = "/foo") {
set $naxsi_flag_enable 1;
}
location / {
SecRulesEnabled;
SecRulesDisabled;
}
}}}



== naxsi_extensive_log ==

If present (and set to “1”), this variable will force naxsi to log the CONTENT of variable matching rules.

Because of potential performances impacts of naxsi_extensive log, use it with caution. Naxsi will log those to nginx’s error_log, ie:

NAXSI_EXLOG: ip=%V&server=%V&uri=%V&id=%d&zone=%s&var_name=%V&content=%V